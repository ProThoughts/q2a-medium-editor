<dialog id="video-dialog" class="mdl-dialog">
    <h4 class="mdl-dialog__title">動画の公開</h4>
    <div class="mdl-dialog__content">
        <p>動画の最大サイズは^maxFileSizeMB MBです。動画は非常にサイズが大きいため30秒以内の動画をお勧めします。アップロードには10分程度かかる場合があります</p>
        <h7>スマホから投稿される方へ</h7>
        <p>スマホで撮影した動画を簡単にアップロードできます。データ通信量が大変大きいため、<strong>WiFi</strong>に接続の上、ご投稿ください。</p>
        <div id="upload-section">
            <form id="upload-form" action="" enctype="multipart/form-data" method="POST" onsubmit="return false">
                <div>
                    <span class="video-step">1. ファイルを選択してください。</span>
                    <div>
                        <input type="file" id="movie-file" name="my_file" accept="video/*" />
                    </div>
                    <div id="video-size-section">
                        動画サイズ: <span id="video-size">0</span> MB (最大 ^maxFileSizeMB MB)
                        <span id="video-size-error"></span>
                    </div>
                </div>
                <br/>
                <div>
                    <span class="video-step">2. 動画サイズを確認の上、アップロードしてください</span>
                    <span class="video-step"></span>
                    <button id="upload-button" type="submit" class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-button--accent" disabled>
                        アップロードする
                    </button>
                </div>
            </form>
            <div id="v-upload-progress" class="mdl-progress mdl-js-progress"></div>
            <div id="v-upload-message"></div>
        </div>
    </div>
    <div class="mdl-dialog__actions">
        <button type="button" class="mdl-button ok">キャンセル</button>
    </div>
</dialog>
<script>
$(function() {
    var videoDialog = document.querySelector('#video-dialog');
    if (!videoDialog.showModal) {
        dialogPolyfill.registerDialog(errDialog);
    }
    videoDialog.querySelector('.ok').addEventListener('click', function() {
        videoDialog.close();
    });

    var Const = {};
    Const.MAX_FILE_SIZE_MB = ^maxFileSizeMB;
    var uploadedData = {};

    var uploadDisableFlg = true;
    $videoEl = $('#movie-file')
    $videoEl.on('change', function() {
        console.log('file changed');
        var file = this.files[0];
        if (file) {
            console.log('file size:' + file.size);
            console.log('limit:' + Const.MAX_FILE_SIZE_MB * 1024 * 1024);
            var fileSizeMB = (file.size / (1024 * 1024)).toFixed(0);
            $('#video-size').text(fileSizeMB);
            if (file.size > Const.MAX_FILE_SIZE_MB * 1024 * 1024) {
                $('#video-size-error').text('サイズが大きすぎます。');
                uploadDisableFlg = true;
            } else {
                uploadDisableFlg = false;
                $('#video-size-error').text('');
            }
        } else {
            uploadDisableFlg = true;
        }
        $('#upload-button').prop('disabled', uploadDisableFlg);
    });

    $videoFormEl = $('#upload-form');
    $videoFormEl.transloadit({
        wait: true, // wait encoding after uploading
        params: {
            auth: {
                key: "01468700276c11e7935dd5bfdcd1978a"
            },
            template_id: "0c671ee0276e11e7bbdd13fca8166c81"
        },
        modal: false,
        onError: function(assembly) {
            alert(assembly.error + ': ' + assembly.message);
        },
        onStart: function(assembly) {
            console.log(">>> onStart", assembly);
            $('#v-upload-message').text('アップロード中です。');
        },
        onProgress: function(bytesIn, totalBytes) {
            console.log('>>>onProgress', bytesIn, totalBytes);
            var progress = (bytesIn / totalBytes * 100).toFixed(2);
            if (progress == 100) {
                return;
            }

            progressbar = document.querySelector('#v-upload-progress');
            progressbar.MaterialProgress.setProgress(progress);
            progressbar.MaterialProgress.setBuffer(87);
        },
        onSuccess: function(assembly) {
            progressbar = document.querySelector('#v-upload-progress');
            progressbar.parentNode.removeChild(progressbar);
            $('#v-upload-message').text('');

            console.log('Assembly finished successfully with', assembly.ok);
            console.log(assembly);
            $('.medium-insert-videos').html(
                '<video class="video-js" controls preload="auto" width="640" poster="' + uploadedData['image_thumb'] + '" data-setup="{}">' +
                '<source id="mp4-source" type="video/mp4" src="' + uploadedData['video_mp4'] + '">' +
                '<source id="webm-source" src="' + uploadedData['video_webm'] + '" type="video/webm">' +
                '</video>' +
                '<div class="video-transloadit-id">[uploaded-video="' + assembly.assembly_id + '"]</div>'
            );

            videoDialog.close();
        },
        onExecuting: function() {
            console.log('>>Uploading finished!');
        },
        onUpload: function(uploadedFile) {
            console.log('>>Upload added', uploadedFile);
            $('#v-upload-progress').addClass("mdl-progress__indeterminate");
            $('#v-upload-message').text('アップロードが完了しました。動画を処理しています。この処理には数分かかることがあります');
        },
        onResult: function(stepName, result) {
            console.log('Result added', stepName, result);
            uploadedData[stepName] = result['ssl_url'];
        },
        onError: function(error) {},
        onDisconnect: function() {
            console.log('Disconnected!');
        },
        onReconnect: function(error) {
            console.log('Reconnected!');
        }
    });
});
</script>
<style>
    dialog#video-dialog {
        min-width: 350px;
    }

    #video-size-section {}

    #video-size {}

    #video-size-error {
        color: #ff0000;
    }
</style>
